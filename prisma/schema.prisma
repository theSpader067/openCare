generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                String  @id
  userId            Int
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  User              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Activity {
  id          Int       @id @default(autoincrement())
  title       String
  horaire     String?
  category    String?
  details     String?
  place       String?
  activityDay DateTime?
  creatorId   Int
  createdAt   DateTime  @default(now())
  updatedAt   DateTime
  quipe       String?   @map("Ã©quipe")
  User        User      @relation(fields: [creatorId], references: [id], onDelete: Cascade)
}

model Analyse {
  id             Int        @id @default(autoincrement())
  createdAt      DateTime   @default(now())
  updatedAt      DateTime
  category       String?
  title          String?
  patientId      Int?
  patientName    String?
  patientAge     String?
  patientHistory String?
  details        String?
  interpretation String?
  status         String?
  labId          String     @unique
  creatorId      Int
  User           User       @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  Patient        Patient?   @relation(fields: [patientId], references: [id])
  LabEntry       LabEntry[]
}

model Avis {
  id                    Int       @id @default(autoincrement())
  createdAt             DateTime  @default(now())
  updatedAt             DateTime
  patientId             Int?
  patientName           String?
  patientAge            String?
  patientHistory        String?
  creatorId             Int
  details               String?
  answer                String?
  answer_date           DateTime?
  destination_specialty String?
  User                  User      @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  Patient               Patient?  @relation(fields: [patientId], references: [id])
}

model Contact {
  id        Int      @id @default(autoincrement())
  fullName  String
  email     String
  specialty String
  message   String
  createdAt DateTime @default(now())
  updatedAt DateTime
}

model FavouriteTask {
  id        Int      @id @default(autoincrement())
  title     String
  creatorId Int
  createdAt DateTime @default(now())
  updatedAt DateTime
  User      User     @relation(fields: [creatorId], references: [id], onDelete: Cascade)
}

model LabEntry {
  id             Int      @id @default(autoincrement())
  analyseId      Int
  createdAt      DateTime @default(now())
  updatedAt      DateTime
  interpretation String?
  name           String?
  value          String?
  Analyse        Analyse  @relation(fields: [analyseId], references: [id], onDelete: Cascade)
}

model Notification {
  id          Int      @id @default(autoincrement())
  category    String?
  title       String
  description String?
  source      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime
}

model Observation {
  id        Int      @id @default(autoincrement())
  text      String
  patientId Int
  createdAt DateTime @default(now())
  updatedAt DateTime
  Patient   Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
}

model Ordonnance {
  id                 Int       @id @default(autoincrement())
  title              String
  createdAt          DateTime  @default(now())
  updatedAt          DateTime
  patientId          Int?
  patientName        String?
  patientAge         String?
  patientHistory     String?
  remarquesConsignes String?
  details            String?
  creatorId          Int
  isPrivate          Boolean   @default(false)
  date               DateTime?
  teamsData          String?
  User               User      @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  Patient            Patient?  @relation(fields: [patientId], references: [id])
}

model OrdonnanceTemplate {
  id                    Int      @id @default(autoincrement())
  title                 String
  class                 String
  prescriptionDetails   String
  prescriptionConsignes String?
  creatorId             Int
  createdAt             DateTime @default(now())
  updatedAt             DateTime
  isPublic              Boolean  @default(false)
  User                  User     @relation(fields: [creatorId], references: [id], onDelete: Cascade)
}

model CR_template {
  id                    Int      @id @default(autoincrement())
  title                 String
  details               String?
  recommendationsPostop String?
  specialite            String?
  creatorId             Int
  createdAt             DateTime @default(now())
  updatedAt             DateTime
  isPublic              Boolean  @default(false)
  User                  User     @relation(fields: [creatorId], references: [id], onDelete: Cascade)
}

model PasswordResetToken {
  identifier String   @id
  token      String   @unique
  email      String
  expires    DateTime
  createdAt  DateTime @default(now())

  @@index([email])
  @@index([expires])
}

model Patient {
  id                  Int           @id @default(autoincrement())
  fullName            String
  pid                 String        @unique
  dateOfBirth         DateTime?
  service             String?
  status              String?
  userId              Int
  isPrivate           Boolean       @default(false)
  nextContact         String?
  diagnostic          String?
  cim                 String?
  atcdsMedical        String?
  atcdsChirurgical    String?
  atcdsExtra          String?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime
  addressHabitat      String?
  addressOrigin       String?
  couvertureSociale   String?
  atcdsFamiliaux      String?
  atcdsGynObstetrique String?
  motif               String?
  profession          String?
  situationFamiliale  String?
  fdrs                String?
  Analyse             Analyse[]
  Avis                Avis[]
  Observation         Observation[]
  Ordonnance          Ordonnance[]
  User                User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  Rapport             Rapport[]
  Task                Task[]
  Episode             Episode[]
}

model Rapport {
  id             Int       @id @default(autoincrement())
  title          String
  category       String?
  date           DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  duration       String?
  patientId      Int?
  patient        Patient?  @relation(fields: [patientId], references: [id], onDelete: SetNull)
  patientName    String?
  patientAge     String?
  patientHistory String?
  operators      String?   @default("")
  participants   User[]    @relation("RapportParticipants")
  details        String?   @db.Text
  recommandations String?  @db.Text
  creatorId      Int
  creator        User      @relation("RapportCreator", fields: [creatorId], references: [id], onDelete: Cascade)
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       Int
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Task {
  id             Int      @id @default(autoincrement())
  title          String
  creatorId      Int
  isPrivate      Boolean  @default(false)
  isComplete     Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime
  patientAge     String?
  patientHistory String?
  patientId      Int?
  patientName    String?
  teamsData      String?
  User           User     @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  Patient        Patient? @relation(fields: [patientId], references: [id])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Team {
  id                      Int           @id @default(autoincrement())
  name                    String
  hospital                String?
  service                 String?
  adminId                 Int
  createdAt               DateTime      @default(now())
  updatedAt               DateTime
  admin                   User          @relation("TeamAdmin", fields: [adminId], references: [id], onDelete: Cascade)
  TeamRequest             TeamRequest[]
  members                 User[]        @relation("TeamMembers")
}

model TeamRequest {
  id        Int      @id @default(autoincrement())
  senderId  Int
  teamId    Int
  accepted  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime
  User      User     @relation(fields: [senderId], references: [id], onDelete: Cascade)
  Team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
}

model User {
  id                              Int                  @id @default(autoincrement())
  firstName                       String?
  lastName                        String?
  username                        String?
  email                           String               @unique
  phone                           String?
  createdAt                       DateTime             @default(now())
  updatedAt                       DateTime
  emailVerified                   Boolean              @default(false)
  image                           String?
  password                        String?
  specialty                       String?
  hospital                        String?
  year                            String?
  onboardingCompleted             Boolean              @default(false)
  biographie                      String?
  notifyByEmail                   Boolean              @default(false)
  notifyByPush                    Boolean              @default(false)
  profileVisible                  Boolean              @default(true)
  addresse                        String?
  language                        String?              @default("en")
  Account                         Account[]
  Activity                        Activity[]
  Analyse                         Analyse[]
  Avis                            Avis[]
  FavouriteTask                   FavouriteTask[]
  Ordonnance                      Ordonnance[]
  OrdonnanceTemplate              OrdonnanceTemplate[]
  CR_template                     CR_template[]
  Patient                         Patient[]
  rapportsAsCreator               Rapport[]            @relation("RapportCreator")
  Session                         Session[]
  Task                            Task[]
  teamsAsAdmin                    Team[]               @relation("TeamAdmin")
  TeamRequest                     TeamRequest[]
  VerificationToken               VerificationToken[]
  rapportParticipations           Rapport[]            @relation("RapportParticipants")
  teamsAsMember                   Team[]               @relation("TeamMembers")
  Episode                          Episode[]
}

model VerificationCode {
  id          Int      @id @default(autoincrement())
  email       String   @unique
  code        String
  expiresAt   DateTime
  attempts    Int      @default(0)
  maxAttempts Int      @default(5)
  createdAt   DateTime @default(now())

  @@index([email])
  @@index([expiresAt])
}

model VerificationToken {
  identifier String   @id
  token      String   @unique
  userId     Int
  expires    DateTime
  User       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([identifier, token])
}

model Episode {
  id        String    @id @default(cuid())
  entryAt   DateTime
  exitAt    DateTime?
  motif     String
  status    EpisodeStatus
  fullname  String
  sex       String
  age       Int?
  origin    String?
  patientId Int?
  patient   Patient?  @relation(fields: [patientId], references: [id], onDelete: SetNull)
  creatorId Int
  creator   User      @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  atcds     String?
  clinique  String?
  paraclinique String?
  cats      CAT[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model CAT {
  id               String      @id @default(cuid())
  title            String
  episodeId        String
  episode          Episode     @relation(fields: [episodeId], references: [id], onDelete: Cascade)
  blocks           CATBlock[]
  currentBlockId   String?     @unique
  currentBlock     CATBlock?   @relation("CurrentBlock", fields: [currentBlockId], references: [id], onDelete: SetNull)
  chosenPath       String[]    @default([])
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
}

model CATBlock {
  id              String         @id @default(cuid())
  catId           String
  cat             CAT            @relation(fields: [catId], references: [id], onDelete: Cascade)
  currentInCAT    CAT?           @relation("CurrentBlock")
  type            CATBlockType
  content         String
  status          CATBlockStatus
  blockDepth      Int
  duration        Int?
  parentBlockIds  String[]       @default([])
  childBlockIds   String[]       @default([])
  activatedAt     DateTime?
  completedAt     DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
}

enum EpisodeStatus {
  CREATED
  ACTIVE
  PAUSED
  CLOSED
}

enum CATBlockType {
  ACTION
  CONDITION
  WAIT
}

enum CATBlockStatus {
  PENDING
  ACTIVE
  COMPLETED
  SKIPPED
}
